<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>VideoDB Context Overlay</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      background: transparent;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji';
    }
    .container {
      background: rgba(22, 22, 22, 0.95);
      border-radius: 12px;
      padding: 12px;
      color: #fff;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      min-height: 120px;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
    .header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 8px; -webkit-app-region: drag; flex-shrink: 0;
    }
    .title { font-size: 13px; font-weight: 600; color: #e5e5e7; }
    .close-btn {
      width: 22px; height: 22px; border-radius: 50%; border: none;
      background: rgba(255,255,255,0.06); color: #666; font-size: 13px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      -webkit-app-region: no-drag; transition: all 0.15s;
    }
    .close-btn:hover { background: rgba(255,255,255,0.12); color: #ccc; }

    /* ‚îÄ‚îÄ‚îÄ Toggle Bar ‚îÄ‚îÄ‚îÄ */
    .toggle-bar {
      display: flex; gap: 2px; margin-bottom: 8px; flex-shrink: 0;
      background: rgba(255, 255, 255, 0.03); border-radius: 8px; padding: 2px;
    }
    .toggle-btn {
      position: relative; flex: 1; padding: 5px 6px; font-size: 10px; font-weight: 500;
      border: none; border-radius: 6px; background: transparent; color: #555;
      cursor: pointer; transition: all 0.15s ease; -webkit-app-region: no-drag;
      display: flex; align-items: center; justify-content: center; gap: 4px;
    }
    .toggle-btn:hover { color: #888; }
    .toggle-btn.active { background: rgba(255, 255, 255, 0.08); color: #ddd; font-weight: 600; }
    .toggle-notif {
      display: none; width: 6px; height: 6px; border-radius: 50%;
      background: #ff453a; flex-shrink: 0; animation: notif-pulse 1.5s ease-in-out infinite;
    }
    .toggle-notif.visible { display: block; }
    @keyframes notif-pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(0.8); }
    }

    /* ‚îÄ‚îÄ‚îÄ Panels Area ‚îÄ‚îÄ‚îÄ */
    .panels-area {
      flex: 1; display: flex; flex-direction: column; gap: 6px;
      overflow: hidden; min-height: 0;
    }

    /* ‚îÄ‚îÄ‚îÄ Panel Card ‚îÄ‚îÄ‚îÄ */
    .panel {
      display: none; flex-direction: column; overflow: hidden; min-height: 0;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 8px; padding: 8px 10px;
    }
    .panel.open { display: flex; flex: 1 1 0; min-height: 44px; }
    .panel-scroll {
      flex: 1; overflow-y: auto; min-height: 0;
    }
    .panel-scroll::-webkit-scrollbar { width: 4px; }
    .panel-scroll::-webkit-scrollbar-track { background: transparent; }
    .panel-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
    .panel-scroll::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
    .panel-empty {
      display: flex; align-items: center; justify-content: center;
      padding: 16px 8px; color: #3a3a3a; font-size: 11px; text-align: center;
    }

    /* ‚îÄ‚îÄ‚îÄ Divider ‚îÄ‚îÄ‚îÄ */
    .panel-divider {
      height: 8px; flex-shrink: 0; cursor: row-resize;
      position: relative; -webkit-app-region: no-drag; margin: -3px 0; z-index: 2;
    }
    .panel-divider::after {
      content: ''; position: absolute; left: 25%; right: 25%; top: 50%;
      height: 2px; border-radius: 1px; transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.08); transition: background 0.15s;
    }
    .panel-divider:hover::after,
    .panel-divider.dragging::after { background: rgba(255, 255, 255, 0.25); }

    /* ‚îÄ‚îÄ‚îÄ Response Panel ‚Äî Markdown ‚îÄ‚îÄ‚îÄ */
    .overlay-content {
      font-size: 12px; line-height: 1.6; color: #ccc; word-break: break-word;
    }
    .overlay-content h1 { font-size: 16px; font-weight: 700; color: #f0f0f0; margin: 12px 0 6px; }
    .overlay-content h2 { font-size: 14px; font-weight: 700; color: #e0e0e0; margin: 10px 0 4px; }
    .overlay-content h3 { font-size: 12px; font-weight: 700; color: #ddd; margin: 8px 0 3px; }
    .overlay-content p { margin: 4px 0; }
    .overlay-content strong { color: #eee; font-weight: 600; }
    .overlay-content em { font-style: italic; color: #bbb; }
    .overlay-content code {
      font-family: 'SF Mono', Menlo, Monaco, monospace; font-size: 11px;
      background: rgba(255,255,255,0.06); padding: 1px 4px; border-radius: 3px; color: #e8c26a;
    }
    .overlay-content pre {
      margin: 6px 0; padding: 8px 10px; border-radius: 6px;
      background: rgba(0, 0, 0, 0.35); overflow-x: auto;
      border: 1px solid rgba(255,255,255,0.04);
    }
    .overlay-content pre code {
      background: none; padding: 0; color: #ccc; font-size: 11px;
      line-height: 1.5; white-space: pre;
    }
    .overlay-content ul, .overlay-content ol {
      margin: 4px 0; padding-left: 18px;
    }
    .overlay-content li { margin: 2px 0; }
    .overlay-content blockquote {
      border-left: 2px solid rgba(255,255,255,0.15); padding-left: 8px;
      margin: 4px 0; color: #999;
    }
    .overlay-content hr {
      border: none; border-top: 1px solid rgba(255,255,255,0.08); margin: 8px 0;
    }

    /* Loading */
    .loading-wrap {
      display: none; flex: 1; flex-direction: column; align-items: center;
      justify-content: center; gap: 12px; padding: 12px 8px;
    }
    .loading-wrap.visible { display: flex; }
    .loading-orb {
      width: 28px; height: 28px; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(10, 132, 255, 0.35), rgba(191, 90, 242, 0.25) 60%, transparent 70%);
      animation: orb-breathe 2s ease-in-out infinite; position: relative;
    }
    .loading-orb::after {
      content: ''; position: absolute; inset: -2px; border-radius: 50%;
      border: 1.5px solid transparent; border-top-color: rgba(10, 132, 255, 0.5);
      border-right-color: rgba(191, 90, 242, 0.25); animation: spin 1.2s linear infinite;
    }
    @keyframes orb-breathe {
      0%, 100% { transform: scale(1); opacity: 0.7; }
      50% { transform: scale(1.08); opacity: 1; }
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { font-size: 11px; color: #555; }
    .loading-word {
      display: inline-block; transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .loading-word.fade-out { opacity: 0; transform: translateY(-3px); }
    .loading-dots::after { content: ''; animation: dots 1.5s steps(4, end) infinite; }
    @keyframes dots {
      0% { content: ''; } 25% { content: '.'; } 50% { content: '..'; } 75% { content: '...'; }
    }
    .loading-skeleton { width: 80%; display: flex; flex-direction: column; gap: 5px; margin-top: 4px; }
    .skeleton-line {
      height: 6px; border-radius: 3px;
      background: linear-gradient(90deg, rgba(255,255,255,0.02) 25%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0.02) 75%);
      background-size: 200% 100%; animation: shimmer 1.5s ease-in-out infinite;
    }
    .skeleton-line:nth-child(1) { width: 90%; }
    .skeleton-line:nth-child(2) { width: 60%; }
    .skeleton-line:nth-child(3) { width: 75%; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    /* ‚îÄ‚îÄ‚îÄ Activity Items ‚îÄ‚îÄ‚îÄ */
    .activity-top-row {
      display: flex; align-items: center; justify-content: flex-end;
      margin-bottom: 2px; flex-shrink: 0;
    }
    .activity-clear-btn {
      font-size: 9px; color: #444; background: none; border: none;
      cursor: pointer; -webkit-app-region: no-drag; padding: 2px 4px;
    }
    .activity-clear-btn:hover { color: #888; }
    .activity-item {
      display: flex; align-items: center; gap: 5px; padding: 2px 0;
      font-size: 11px; color: #999; position: relative; cursor: default;
    }
    .activity-icon {
      width: 14px; height: 14px; display: flex; align-items: center;
      justify-content: center; flex-shrink: 0; font-size: 10px;
    }
    .activity-icon .mini-spin {
      width: 9px; height: 9px;
      border: 1.5px solid rgba(255, 255, 255, 0.1); border-top-color: #0a84ff;
      border-radius: 50%; animation: spin 0.7s linear infinite;
    }
    .activity-icon.done { color: #30d158; }
    .activity-icon.fail { color: #ff453a; font-weight: 700; }
    .activity-item.failed {
      background: rgba(255,69,58,0.08); border-radius: 4px; padding: 2px 4px;
      border-left: 2px solid #ff453a;
    }
    .activity-item.failed .activity-detail { color: #ff6961; }
    .activity-item.failed .activity-tool-name { color: #ff8a80; }
    .activity-label {
      flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
      font-family: 'SF Mono', Menlo, Monaco, monospace; font-size: 10px;
    }
    .activity-tool-name { color: #bbb; font-weight: 600; }
    .activity-detail { color: #555; margin-left: 3px; }
    .activity-duration {
      flex-shrink: 0; font-size: 9px; font-variant-numeric: tabular-nums; color: #444;
    }
    .activity-item.mcp-tool { border-left: 2px solid #bf5af2; padding-left: 5px; margin-left: 1px; }
    .activity-badge {
      display: inline-block; font-size: 7px; font-weight: 700; letter-spacing: 0.3px;
      padding: 1px 3px; border-radius: 2px; margin-right: 3px;
      vertical-align: middle; line-height: 1.3;
    }
    .activity-badge.mcp { background: rgba(191, 90, 242, 0.2); color: #bf5af2; }
    /* ‚îÄ‚îÄ‚îÄ Activity tooltip ‚îÄ‚îÄ‚îÄ */
    .activity-tooltip {
      display: none; position: fixed; z-index: 9999;
      background: #1e1e1e; border: 1px solid rgba(255,255,255,0.1);
      border-radius: 6px; padding: 8px 10px; max-width: 360px; min-width: 160px;
      font-size: 10px; color: #ccc; line-height: 1.5;
      font-family: 'SF Mono', Menlo, Monaco, monospace;
      box-shadow: 0 4px 16px rgba(0,0,0,0.5); pointer-events: none;
      word-break: break-word; white-space: pre-wrap;
    }
    .activity-tooltip.visible { display: block; }
    .activity-tooltip .tt-label { color: #666; font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
    .activity-tooltip .tt-value { color: #ddd; margin-bottom: 6px; }
    .activity-tooltip .tt-value:last-child { margin-bottom: 0; }
    .activity-tooltip .tt-error { color: #ff453a; }
    .activity-tooltip .tt-status { font-weight: 600; margin-bottom: 6px; }
    .activity-tooltip .tt-status.running { color: #0a84ff; }
    .activity-tooltip .tt-status.done { color: #30d158; }
    .activity-tooltip .tt-status.fail { color: #ff453a; }
    /* ‚îÄ‚îÄ‚îÄ Running agents strip ‚îÄ‚îÄ‚îÄ */
    .running-agents {
      display: none; flex-shrink: 0; gap: 4px; flex-wrap: wrap;
      padding: 4px 0 6px; border-bottom: 1px solid rgba(255,255,255,0.04);
      margin-bottom: 4px;
    }
    .running-agents.visible { display: flex; }
    .agent-chip {
      display: flex; align-items: center; gap: 4px;
      padding: 3px 8px; border-radius: 10px; font-size: 9px; font-weight: 600;
      animation: chip-in 0.2s ease-out;
    }
    .agent-chip .chip-spin {
      width: 8px; height: 8px; border: 1.5px solid rgba(255,255,255,0.15);
      border-radius: 50%; animation: spin 0.7s linear infinite;
    }
    .agent-chip .chip-dur { font-weight: 400; color: rgba(255,255,255,0.4); font-variant-numeric: tabular-nums; margin-left: 2px; }
    .agent-chip.done { opacity: 0.5; }
    .agent-chip.done .chip-spin { animation: none; border-color: transparent; }
    .agent-chip.agent-code-eye { background: rgba(94,92,230,0.15); color: #8b89f5; }
    .agent-chip.agent-code-eye .chip-spin { border-top-color: #5e5ce6; }
    .agent-chip.agent-voice { background: rgba(48,209,88,0.15); color: #5ee679; }
    .agent-chip.agent-voice .chip-spin { border-top-color: #30d158; }
    .agent-chip.agent-hearing { background: rgba(255,214,10,0.15); color: #ffe151; }
    .agent-chip.agent-hearing .chip-spin { border-top-color: #ffd60a; }
    .agent-chip.agent-narrator { background: rgba(10,132,255,0.15); color: #4da6ff; }
    .agent-chip.agent-narrator .chip-spin { border-top-color: #0a84ff; }
    @keyframes chip-in { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

    .activity-item.subagent { border-left: 2px solid #0a84ff; padding-left: 5px; margin-left: 1px; }
    .activity-item.subagent .activity-tool-name { color: #0a84ff; }
    .activity-item.subagent.agent-code-eye { border-left-color: #5e5ce6; }
    .activity-item.subagent.agent-code-eye .activity-tool-name { color: #5e5ce6; }
    .activity-item.subagent.agent-voice { border-left-color: #30d158; }
    .activity-item.subagent.agent-voice .activity-tool-name { color: #30d158; }
    .activity-item.subagent.agent-hearing { border-left-color: #ffd60a; }
    .activity-item.subagent.agent-hearing .activity-tool-name { color: #ffd60a; }
    .activity-item.search-tool { border-left: 2px solid #ff9f0a; padding-left: 5px; margin-left: 1px; }
    .activity-item.search-tool .activity-tool-name { color: #ff9f0a; }
    .activity-item.search-tool .activity-detail { color: #bbb; font-style: italic; }

    /* ‚îÄ‚îÄ‚îÄ Context Panel ‚îÄ‚îÄ‚îÄ */
    .context-tabs { display: flex; gap: 2px; margin-bottom: 6px; flex-shrink: 0; }
    .context-tab {
      padding: 2px 7px; font-size: 10px; border: none; border-radius: 4px;
      background: rgba(255,255,255,0.04); color: #555; cursor: pointer;
      -webkit-app-region: no-drag; transition: all 0.12s;
    }
    .context-tab:hover { background: rgba(255,255,255,0.08); color: #999; }
    .context-tab.active { background: rgba(255,255,255,0.1); color: #ddd; }
    .context-item { padding: 4px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.03); }
    .context-item:last-child { border-bottom: none; }
    .context-item-header {
      display: flex; align-items: center; gap: 5px; margin-bottom: 1px; font-size: 9px; color: #555;
    }
    .context-item-type {
      font-size: 9px; padding: 1px 4px; border-radius: 3px; background: rgba(255,255,255,0.04);
    }
    .context-item-type.screen { color: #0a84ff; }
    .context-item-type.mic { color: #30d158; }
    .context-item-type.system_audio { color: #ffd60a; }
    .context-item-text { font-size: 11px; color: #999; word-break: break-word; line-height: 1.4; }

    /* ‚îÄ‚îÄ‚îÄ Permission Prompt ‚îÄ‚îÄ‚îÄ */
    .permission-prompt {
      display: none; position: absolute; inset: 12px; z-index: 50;
      background: rgba(22, 22, 22, 0.98); border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08);
      flex-direction: column; gap: 10px; padding: 14px;
    }
    .permission-prompt.visible { display: flex; }
    .permission-title {
      font-size: 13px; font-weight: 600; color: #ffd60a;
      display: flex; align-items: center; gap: 6px;
    }
    .permission-tool {
      font-size: 12px; color: #ddd; padding: 6px 8px;
      background: rgba(255, 255, 255, 0.05); border-radius: 6px;
      font-family: 'SF Mono', Menlo, Monaco, monospace;
    }
    .permission-input {
      font-size: 11px; color: #888; max-height: 120px; overflow-y: auto;
      padding: 6px 8px; background: rgba(0, 0, 0, 0.3); border-radius: 6px;
      white-space: pre-wrap; word-break: break-all;
      font-family: 'SF Mono', Menlo, Monaco, monospace;
    }
    .permission-input::-webkit-scrollbar { width: 4px; }
    .permission-input::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
    .permission-buttons { display: flex; gap: 8px; margin-top: 2px; }
    .permission-btn {
      flex: 1; padding: 7px 0; border: none; border-radius: 8px;
      font-size: 12px; font-weight: 600; cursor: pointer; -webkit-app-region: no-drag;
    }
    .permission-btn.allow { background: #30d158; color: #000; }
    .permission-btn.allow:hover { background: #28b94c; }
    .permission-btn.deny { background: #ff453a; color: #fff; }
    .permission-btn.deny:hover { background: #e03e34; }

    /* ‚îÄ‚îÄ‚îÄ Status Bar ‚îÄ‚îÄ‚îÄ */
    .status {
      margin-top: 8px; padding-top: 7px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 10px; color: #555; flex-shrink: 0;
    }
    .status-idle, .status-starting, .status-recording,
    .status-stopping, .status-stopped, .status-exported, .status-failed { display: none; }
    .status-idle.visible, .status-stopping.visible, .status-stopped.visible { display: block; }
    .status-recording.visible { display: flex; flex-wrap: wrap; gap: 8px 12px; align-items: center; }
    .status-failed.visible { display: flex; flex-direction: column; gap: 4px; }
    .channel-item { display: flex; align-items: center; gap: 5px; }
    .status-dot { display: inline-block; width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }
    .status-dot.green { background: #30d158; }
    .status-dot.live { animation: blink 1.2s ease-in-out infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .status-duration { margin-left: auto; font-variant-numeric: tabular-nums; color: #666; }
    .status-latency { display: none; width: 100%; margin-top: 4px; font-size: 9px; font-variant-numeric: tabular-nums; color: #555; }
    .status-latency.visible { display: flex; align-items: center; gap: 5px; }
    .latency-value { color: #777; }
    .latency-value.good { color: #30d158; }
    .latency-value.ok { color: #ffd60a; }
    .latency-value.slow { color: #ff9f0a; }
    .latency-value.bad { color: #ff453a; }
    .latency-waiting { color: #444; font-style: italic; }
    .status-starting { display: none; align-items: center; gap: 6px; }
    .status-starting.visible { display: flex; }
    .mini-spinner {
      width: 10px; height: 10px;
      border: 1.5px solid rgba(255, 255, 255, 0.15); border-top-color: #ffd60a;
      border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    .status-stopping { display: none; align-items: center; gap: 6px; }
    .status-stopping.visible { display: flex; }
    .status-stopped { color: #30d158; }
    .status-exported { color: #0a84ff; }
    .status-exported.visible { display: flex; align-items: center; gap: 6px; }
    .view-btn {
      background: #0a84ff; color: #fff; border: none; border-radius: 4px;
      padding: 2px 7px; font-size: 10px; font-weight: 500; cursor: pointer; margin-left: 3px;
    }
    .view-btn:hover { background: #0077e6; }
    .status-failed-message { color: #ff453a; }
    .status-failed-hint { color: #555; font-size: 9px; }

    /* ‚îÄ‚îÄ‚îÄ Window Resize ‚îÄ‚îÄ‚îÄ */
    .resize-handle {
      position: fixed; bottom: 0; right: 0; width: 14px; height: 14px;
      cursor: nwse-resize; -webkit-app-region: no-drag; z-index: 100;
    }
    .resize-handle::after {
      content: ''; position: absolute; bottom: 3px; right: 3px; width: 7px; height: 7px;
      border-right: 1.5px solid rgba(255, 255, 255, 0.15);
      border-bottom: 1.5px solid rgba(255, 255, 255, 0.15);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <span class="title">üßû Pair Programmer</span>
      <div style="display:flex;gap:6px;align-items:center;-webkit-app-region:no-drag;">
        <button class="close-btn" onclick="closeOverlay()">√ó</button>
      </div>
    </div>

    <!-- Toggle bar ‚Äî order matches panel order: Response, Context, Activity -->
    <div class="toggle-bar">
      <button class="toggle-btn" id="tog-overlay" onclick="togglePanel('overlay')">
        üí¨ Response <span class="toggle-notif" id="notif-overlay"></span>
      </button>
      <button class="toggle-btn" id="tog-context" onclick="togglePanel('context')">
        üì° Context <span class="toggle-notif" id="notif-context"></span>
      </button>
      <button class="toggle-btn active" id="tog-activity" onclick="togglePanel('activity')">
        ‚ö° Activity <span class="toggle-notif" id="notif-activity"></span>
      </button>
    </div>

    <!-- Panels: Response (top) ‚Üí Context ‚Üí Activity (bottom) -->
    <div class="panels-area" id="panelsArea">
      <div class="panel" id="panel-overlay">
        <div class="loading-wrap" id="loadingWrap">
          <div class="loading-orb"></div>
          <span class="loading-text"><span class="loading-word" id="loadingText">Thinking</span><span class="loading-dots"></span></span>
          <div class="loading-skeleton">
            <div class="skeleton-line"></div><div class="skeleton-line"></div><div class="skeleton-line"></div>
          </div>
        </div>
        <div class="panel-scroll" id="overlayScroll">
          <div class="overlay-content" id="overlayContent">
            <div class="panel-empty" id="overlayEmpty">Waiting for response...</div>
          </div>
        </div>
      </div>

      <div class="panel" id="panel-context">
        <div class="context-tabs">
          <button class="context-tab active" data-type="all" onclick="switchContextTab('all', this)">All</button>
          <button class="context-tab" data-type="screen" onclick="switchContextTab('screen', this)">üñ• Screen</button>
          <button class="context-tab" data-type="mic" onclick="switchContextTab('mic', this)">üéô Mic</button>
          <button class="context-tab" data-type="system_audio" onclick="switchContextTab('system_audio', this)">üîä Audio</button>
        </div>
        <div class="panel-scroll" id="contextScroll">
          <div id="contextList"><div class="panel-empty">No context yet</div></div>
        </div>
      </div>

      <div class="panel open" id="panel-activity">
        <div class="activity-top-row">
          <button class="activity-clear-btn" onclick="clearActivityFeed()">clear</button>
        </div>
        <div class="running-agents" id="runningAgents"></div>
        <div class="panel-scroll" id="activityScroll">
          <div id="activityList">
            <div class="panel-empty" id="activityEmpty">Waiting for activity...</div>
          </div>
        </div>
      </div>
    </div>

    <div class="activity-tooltip" id="activityTooltip"></div>

    <div class="permission-prompt" id="permissionPrompt">
      <div class="permission-title">üîê Permission Request</div>
      <div class="permission-tool" id="permissionTool"></div>
      <div class="permission-input" id="permissionInput"></div>
      <div class="permission-buttons">
        <button class="permission-btn allow" onclick="respondPermission('allow')">‚úì Allow</button>
        <button class="permission-btn deny" onclick="respondPermission('deny')">‚úï Deny</button>
      </div>
    </div>

    <div class="status">
      <div class="status-idle visible" id="statusIdle">Type /record in Claude to start recording</div>
      <div class="status-starting" id="statusStarting"><div class="mini-spinner"></div><span>Starting session...</span></div>
      <div class="status-recording" id="statusRecording"></div>
      <div class="status-latency" id="statusLatency"><span>üñ• Latency:</span><span class="latency-value" id="latencyValue">‚Äî</span></div>
      <div class="status-stopping" id="statusStopping"><div class="mini-spinner"></div><span>Stopping recording...</span></div>
      <div class="status-stopped" id="statusStopped">‚úì Recording saved</div>
      <div class="status-exported" id="statusExported">
        <span>‚úì Exported</span>
        <button class="view-btn" id="exportedViewBtn" style="display:none" onclick="openPlayerUrl()">View</button>
      </div>
      <div class="status-failed" id="statusFailed">
        <span class="status-failed-message" id="statusFailedMessage">Recording failed</span>
        <span class="status-failed-hint">Run /record again in Claude to start a new recording.</span>
      </div>
    </div>
  </div>

  <div class="resize-handle" id="resizeHandle"></div>

  <script>
    const { ipcRenderer, shell } = require('electron');

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       Panel state ‚Äî order: overlay ‚Üí context ‚Üí activity (top to bottom)
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    var panelOpen = { overlay: false, context: false, activity: true };
    var PANEL_ORDER = ['overlay', 'context', 'activity'];

    function togglePanel(name) {
      panelOpen[name] = !panelOpen[name];
      applyPanelLayout();
      if (panelOpen[name]) clearNotification(name);
      if (name === 'context') {
        if (panelOpen.context) { fetchContext(); contextRefreshInterval = setInterval(fetchContext, 3000); }
        else { if (contextRefreshInterval) { clearInterval(contextRefreshInterval); contextRefreshInterval = null; } }
      }
    }

    function applyPanelLayout() {
      PANEL_ORDER.forEach(function(name) {
        var btn = document.getElementById('tog-' + name);
        var panel = document.getElementById('panel-' + name);
        if (panelOpen[name]) { btn.classList.add('active'); panel.classList.add('open'); }
        else { btn.classList.remove('active'); panel.classList.remove('open'); panel.style.flex = ''; }
      });
      rebuildDividers();
    }

    /* ‚îÄ‚îÄ‚îÄ Dynamic dividers ‚Äî insert between consecutive open panels ‚îÄ‚îÄ‚îÄ */
    function rebuildDividers() {
      // Remove old dividers
      document.querySelectorAll('.panel-divider').forEach(function(d) { d.remove(); });
      var open = PANEL_ORDER.filter(function(n) { return panelOpen[n]; });
      for (var i = 0; i < open.length - 1; i++) {
        var div = document.createElement('div');
        div.className = 'panel-divider';
        div.dataset.above = open[i];
        div.dataset.below = open[i + 1];
        var panelEl = document.getElementById('panel-' + open[i]);
        panelEl.after(div);
        attachDividerDrag(div);
      }
    }

    function attachDividerDrag(divEl) {
      var startY, aboveH, belowH, aboveEl, belowEl;
      divEl.addEventListener('mousedown', function(e) {
        e.preventDefault();
        aboveEl = document.getElementById('panel-' + divEl.dataset.above);
        belowEl = document.getElementById('panel-' + divEl.dataset.below);
        startY = e.clientY;
        aboveH = aboveEl.getBoundingClientRect().height;
        belowH = belowEl.getBoundingClientRect().height;
        divEl.classList.add('dragging');
        document.addEventListener('mousemove', mv);
        document.addEventListener('mouseup', up);
      });
      function mv(e) {
        var delta = e.clientY - startY;
        aboveEl.style.flex = '0 0 ' + Math.max(44, aboveH + delta) + 'px';
        belowEl.style.flex = '0 0 ' + Math.max(44, belowH - delta) + 'px';
      }
      function up() {
        divEl.classList.remove('dragging');
        document.removeEventListener('mousemove', mv);
        document.removeEventListener('mouseup', up);
      }
    }

    /* ‚îÄ‚îÄ‚îÄ Notifications ‚îÄ‚îÄ‚îÄ */
    function setNotification(panel) {
      if (panelOpen[panel]) return;
      var dot = document.getElementById('notif-' + panel);
      if (dot) dot.classList.add('visible');
    }
    function clearNotification(panel) {
      var dot = document.getElementById('notif-' + panel);
      if (dot) dot.classList.remove('visible');
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       Markdown renderer (lightweight)
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function renderMarkdown(src) {
      if (!src) return '';
      var html = '';
      var lines = src.split('\n');
      var inCode = false, codeLang = '', codeLines = [];
      var inList = false, listType = '';

      for (var idx = 0; idx < lines.length; idx++) {
        var line = lines[idx];

        // Fenced code block toggle
        if (line.match(/^```/)) {
          if (!inCode) {
            if (inList) { html += '</' + listType + '>'; inList = false; }
            inCode = true;
            codeLang = line.replace(/^```\s*/, '');
            codeLines = [];
          } else {
            html += '<pre><code>' + escapeHtml(codeLines.join('\n')) + '</code></pre>';
            inCode = false;
          }
          continue;
        }
        if (inCode) { codeLines.push(line); continue; }

        // Close list if line is not a list item
        var isUl = /^\s*[-*]\s+/.test(line);
        var isOl = /^\s*\d+\.\s+/.test(line);
        if (inList && !isUl && !isOl) {
          html += '</' + listType + '>';
          inList = false;
        }

        // Headings
        if (/^### /.test(line)) { html += '<h3>' + inline(line.slice(4)) + '</h3>'; continue; }
        if (/^## /.test(line))  { html += '<h2>' + inline(line.slice(3)) + '</h2>'; continue; }
        if (/^# /.test(line))   { html += '<h1>' + inline(line.slice(2)) + '</h1>'; continue; }

        // HR
        if (/^---+$/.test(line.trim())) { html += '<hr>'; continue; }

        // Blockquote
        if (/^>\s?/.test(line)) { html += '<blockquote>' + inline(line.replace(/^>\s?/, '')) + '</blockquote>'; continue; }

        // Lists
        if (isUl) {
          if (!inList || listType !== 'ul') { if (inList) html += '</' + listType + '>'; html += '<ul>'; inList = true; listType = 'ul'; }
          html += '<li>' + inline(line.replace(/^\s*[-*]\s+/, '')) + '</li>';
          continue;
        }
        if (isOl) {
          if (!inList || listType !== 'ol') { if (inList) html += '</' + listType + '>'; html += '<ol>'; inList = true; listType = 'ol'; }
          html += '<li>' + inline(line.replace(/^\s*\d+\.\s+/, '')) + '</li>';
          continue;
        }

        // Empty line
        if (line.trim() === '') { continue; }

        // Paragraph
        html += '<p>' + inline(line) + '</p>';
      }

      if (inCode) html += '<pre><code>' + escapeHtml(codeLines.join('\n')) + '</code></pre>';
      if (inList) html += '</' + listType + '>';
      return html;
    }

    function inline(text) {
      var s = escapeHtml(text);
      s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
      s = s.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      s = s.replace(/\*([^*]+)\*/g, '<em>$1</em>');
      return s;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       Response Panel
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    var hasOverlayContent = false;

    var LOADING_WORDS = [
      'Thinking', 'Pondering', 'Reasoning', 'Contemplating', 'Mulling',
      'Noodling', 'Wibbling', 'Gibbling', 'Cogitating', 'Ruminating',
      'Percolating', 'Brewing', 'Conjuring', 'Synthesizing', 'Churning',
      'Crunching', 'Untangling', 'Deciphering', 'Simmering', 'Vibing',
    ];
    var loadingWordTimer = null;
    function startLoadingWords() {
      stopLoadingWords(); rotateWord();
      loadingWordTimer = setInterval(rotateWord, 2500 + Math.random() * 1500);
    }
    function stopLoadingWords() { if (loadingWordTimer) { clearInterval(loadingWordTimer); loadingWordTimer = null; } }
    function rotateWord() {
      var el = document.getElementById('loadingText'); if (!el) return;
      el.classList.add('fade-out');
      setTimeout(function() {
        el.textContent = LOADING_WORDS[Math.floor(Math.random() * LOADING_WORDS.length)];
        el.classList.remove('fade-out');
      }, 300);
    }

    ipcRenderer.on('overlay-content', (event, data) => {
      var loadingWrap = document.getElementById('loadingWrap');
      var contentEl = document.getElementById('overlayContent');
      var scrollEl = document.getElementById('overlayScroll');

      if (data.loading) {
        loadingWrap.classList.add('visible');
        scrollEl.style.display = 'none';
        startLoadingWords();
      } else {
        loadingWrap.classList.remove('visible');
        scrollEl.style.display = '';
        stopLoadingWords();
        contentEl.innerHTML = renderMarkdown(data.text || 'No content');
        scrollEl.scrollTop = scrollEl.scrollHeight;
        hasOverlayContent = true;
      }
      setNotification('overlay');
      if (!data.loading && hasOverlayContent && !panelOpen.overlay) {
        panelOpen.overlay = true;
        applyPanelLayout();
        clearNotification('overlay');
      }
    });

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       Status
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    var durationInterval = null, recordingStartTime = null, exportedTimeout = null, currentPlayerUrl = null;

    ipcRenderer.on('overlay-status', (event, data) => {
      hideAllStatus();
      if (data.failed) {
        showStatus('statusFailed');
        document.getElementById('statusFailedMessage').textContent = data.failed.message || 'Recording failed';
      } else if (data.starting && !data.recording) { showStatus('statusStarting');
      } else if (data.recording && data.stopping) { showStatus('statusStopping');
      } else if (data.recording) {
        showStatus('statusRecording'); renderChannels(data.channels, data.duration);
        startDurationTimer(); updateLatency(data.visualLatency);
      } else if (data.exported) {
        showStatus('statusExported'); stopDurationTimer();
        currentPlayerUrl = (data.exported && data.exported.playerUrl) || null;
        document.getElementById('exportedViewBtn').style.display = currentPlayerUrl ? '' : 'none';
        if (exportedTimeout) clearTimeout(exportedTimeout);
        exportedTimeout = setTimeout(function() { hideAllStatus(); showStatus('statusStopped'); exportedTimeout = null; }, 10000);
      } else if (data.stopped) { showStatus('statusStopped'); stopDurationTimer();
      } else { showStatus('statusIdle'); stopDurationTimer(); }
    });
    ipcRenderer.on('overlay-status', (event, data) => {
      if (data.recording && !data.stopping && data.duration != null) { window._baseDuration = data.duration; recordingStartTime = Date.now(); }
      if (data.recording) setNotification('context');
    });

    function hideAllStatus() {
      ['statusIdle','statusStarting','statusRecording','statusStopping',
       'statusStopped','statusExported','statusFailed','statusLatency'].forEach(function(id) {
        document.getElementById(id).classList.remove('visible');
      });
    }
    function showStatus(id) { document.getElementById(id).classList.add('visible'); }
    function channelEmoji(n) {
      n = n.toLowerCase();
      if (n.includes('display') || n.includes('screen')) return 'üñ•';
      if (n.includes('mic')) return 'üéô';
      if (n.includes('system') || n.includes('audio')) return 'üîä';
      return 'üì°';
    }
    function renderChannels(channels, duration) {
      var el = document.getElementById('statusRecording');
      var names = (channels && channels.length) ? channels : ['Recording'];
      var html = names.map(function(n) {
        return '<div class="channel-item"><span class="status-dot green live"></span><span>'+channelEmoji(n)+' '+n+'</span></div>';
      }).join('');
      html += '<span class="status-duration" id="durationLabel">'+formatDuration(duration||0)+'</span>';
      el.innerHTML = html;
    }
    function startDurationTimer() {
      stopDurationTimer(); recordingStartTime = Date.now();
      durationInterval = setInterval(function() {
        var l = document.getElementById('durationLabel');
        if (!l || !document.getElementById('statusRecording').classList.contains('visible')) return;
        l.textContent = formatDuration(Math.round((Date.now()-recordingStartTime)/1000)+(window._baseDuration||0));
      }, 1000);
    }
    function stopDurationTimer() { if (durationInterval) { clearInterval(durationInterval); durationInterval = null; } recordingStartTime = null; }
    function formatDuration(s) { var m = Math.floor(s/60), sc = s%60; return m+':'+(sc<10?'0':'')+sc; }
    function updateLatency(ms) {
      var el = document.getElementById('statusLatency'), val = document.getElementById('latencyValue');
      el.classList.add('visible');
      if (ms == null) { val.textContent = 'waiting...'; val.className = 'latency-value latency-waiting'; return; }
      val.className = 'latency-value';
      if (ms < 100) { val.textContent = '<100ms'; val.classList.add('good'); }
      else { val.textContent = (ms/1000).toFixed(2)+'s'; val.classList.add(ms<5000?'good':ms<10000?'ok':ms<20000?'slow':'bad'); }
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       Context
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    var contextTab = 'all', contextRefreshInterval = null;
    function switchContextTab(type, btn) {
      contextTab = type;
      document.querySelectorAll('.context-tab').forEach(function(t) { t.classList.remove('active'); });
      btn.classList.add('active'); fetchContext();
    }
    async function fetchContext() {
      try { var data = await ipcRenderer.invoke('get-context', contextTab === 'all' ? 'all' : contextTab); renderContext(data); }
      catch (e) { document.getElementById('contextList').innerHTML = '<div class="panel-empty">Failed to load</div>'; }
    }
    function renderContext(data) {
      var list = document.getElementById('contextList'), items = [];
      if (contextTab === 'all') {
        ['screen','mic','system_audio'].forEach(function(t) {
          (data[t]||[]).forEach(function(i) { items.push({type:t,text:i.text,timestamp:i.timestamp}); });
        });
        items.sort(function(a,b) { return (a.timestamp||'').localeCompare(b.timestamp||''); });
      } else {
        (data[contextTab]||[]).forEach(function(i) { items.push({type:contextTab,text:i.text,timestamp:i.timestamp}); });
      }
      if (!items.length) { list.innerHTML = '<div class="panel-empty">No context yet</div>'; return; }
      var em = {screen:'üñ•',mic:'üéô',system_audio:'üîä'};
      var html = items.map(function(i) {
        var time = i.timestamp ? new Date(i.timestamp).toLocaleTimeString() : '';
        return '<div class="context-item"><div class="context-item-header">' +
          '<span class="context-item-type '+i.type+'">'+(em[i.type]||'üì°')+' '+i.type.replace('_',' ')+'</span>' +
          '<span>'+time+'</span></div>' +
          '<div class="context-item-text">'+escapeHtml(i.text||'(empty)')+'</div></div>';
      }).join('');
      var sc = document.getElementById('contextScroll');
      var atBot = sc.scrollHeight - sc.scrollTop - sc.clientHeight < 30;
      list.innerHTML = html;
      if (atBot) sc.scrollTop = sc.scrollHeight;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       Activity
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    var activityItems = {}, activitySeq = 0, pendingTools = {}, hasActivityItems = false;

    ipcRenderer.on('hook-event', (event, data) => {
      var list = document.getElementById('activityList');
      var scrollEl = document.getElementById('activityScroll');
      if (!hasActivityItems) { var e = document.getElementById('activityEmpty'); if (e) e.remove(); hasActivityItems = true; }
      setNotification('activity');

      if (data.event === 'PreToolUse') {
        activitySeq++; var seq = activitySeq;
        var tn = data.tool_name||'unknown', detail = summarizeInput(tn, data.tool_input);
        if (!pendingTools[tn]) pendingTools[tn] = [];
        pendingTools[tn].push(seq);
        activityItems[seq] = { toolName: tn, start: Date.now(), status: 'running', input: data.tool_input || '' };
        var el = document.createElement('div');
        var cls = 'activity-item';
        if (tn === 'Search') cls += ' search-tool';
        else if (isMcpTool(tn)) cls += ' mcp-tool';
        el.className = cls; el.id = 'activity-'+seq; el.dataset.seq = seq;
        el.innerHTML = '<div class="activity-icon"><div class="mini-spin"></div></div>' +
          '<div class="activity-label"><span class="activity-tool-name">'+prettifyToolName(tn)+'</span>' +
          '<span class="activity-detail">'+escapeHtml(detail)+'</span></div>' +
          '<span class="activity-duration" id="activity-dur-'+seq+'"></span>';
        el.addEventListener('mouseenter', showActivityTooltip);
        el.addEventListener('mouseleave', hideActivityTooltip);
        list.appendChild(el); scrollEl.scrollTop = scrollEl.scrollHeight;
        activityItems[seq].timer = setInterval(function() {
          var d = document.getElementById('activity-dur-'+seq);
          if (d) d.textContent = ((Date.now()-activityItems[seq].start)/1000).toFixed(1)+'s';
        }, 200);
      }
      if (data.event === 'PostToolUse' || data.event === 'PostToolUseFailure') {
        var tn = data.tool_name||'unknown', q = pendingTools[tn];
        var seq = q && q.length > 0 ? q.shift() : null;
        if (seq && activityItems[seq]) {
          var it = activityItems[seq]; if (it.timer) clearInterval(it.timer);
          var elapsed = ((Date.now()-it.start)/1000).toFixed(1);
          it.elapsed = elapsed;
          it.output = data.tool_output || '';
          if (data.event==='PostToolUse') { it.status = 'done'; }
          else { it.status = 'fail'; }
          var el = document.getElementById('activity-'+seq);
          if (el) {
            var ic = el.querySelector('.activity-icon');
            if (it.status==='done') { ic.innerHTML='‚úì'; ic.className='activity-icon done'; }
            else {
              ic.innerHTML='‚úó'; ic.className='activity-icon fail';
              el.classList.add('failed');
              var dt = el.querySelector('.activity-detail');
              if (dt && it.output) {
                var errMsg = it.output;
                try { errMsg = JSON.parse(errMsg); } catch(_) {}
                errMsg = String(errMsg).substring(0, 80);
                if (errMsg.length >= 80) errMsg += '‚Ä¶';
                dt.textContent = errMsg;
              }
            }
            var d = document.getElementById('activity-dur-'+seq); if (d) d.textContent = elapsed+'s';
          }
          if (q && !q.length) delete pendingTools[tn];
        }
      }
      if (data.event === 'Stop') {
        Object.keys(pendingTools).forEach(function(k) {
          var q = pendingTools[k]; if (!Array.isArray(q)) q = [q];
          q.forEach(function(s) {
            if (activityItems[s] && activityItems[s].timer) clearInterval(activityItems[s].timer);
            var el = document.getElementById('activity-'+s);
            if (el) { var ic = el.querySelector('.activity-icon'); ic.innerHTML='‚óè'; ic.className='activity-icon done'; }
          });
        }); pendingTools = {};
      }
      if (data.event === 'SubagentStart') {
        var at = data.agent_type||'unknown';
        var ico = {'code-eye':'üëÅ','voice':'üé§','hearing':'üîä','narrator':'üìù'}[at]||'‚ö°';
        var strip = document.getElementById('runningAgents');
        var existing = document.getElementById('chip-'+at);
        if (existing) existing.remove();
        var chip = document.createElement('div');
        chip.className = 'agent-chip agent-'+at; chip.id = 'chip-'+at;
        chip.innerHTML = ico+' '+escapeHtml(at)+' <div class="chip-spin"></div><span class="chip-dur"></span>';
        strip.appendChild(chip);
        strip.classList.add('visible');
        var startT = Date.now();
        chip._timer = setInterval(function() {
          var d = chip.querySelector('.chip-dur');
          if (d) d.textContent = ((Date.now()-startT)/1000|0)+'s';
        }, 500);
        // Also add a subtle activity-list entry
        activitySeq++; var seq = activitySeq;
        var ak = '_agent_'+at;
        if (!pendingTools[ak]) pendingTools[ak] = [];
        pendingTools[ak].push(seq);
        activityItems[seq] = { toolName: at, start: startT };
        var el = document.createElement('div');
        el.className = 'activity-item subagent agent-'+at; el.id = 'activity-'+seq;
        el.innerHTML = '<div class="activity-icon">'+ico+'</div>' +
          '<div class="activity-label"><span class="activity-tool-name">'+escapeHtml(at)+'</span>' +
          '<span class="activity-detail">started</span></div>' +
          '<span class="activity-duration" id="activity-dur-'+seq+'"></span>';
        list.appendChild(el); scrollEl.scrollTop = scrollEl.scrollHeight;
      }
      if (data.event === 'SubagentStop') {
        var at = data.agent_type||'unknown';
        var chip = document.getElementById('chip-'+at);
        if (chip) {
          clearInterval(chip._timer);
          chip.classList.add('done');
          var spin = chip.querySelector('.chip-spin'); if (spin) spin.remove();
          setTimeout(function() {
            chip.remove();
            var strip = document.getElementById('runningAgents');
            if (!strip.children.length) strip.classList.remove('visible');
          }, 2000);
        }
        var ak = '_agent_'+at;
        var q = pendingTools[ak], seq = q && q.length > 0 ? q.shift() : null;
        if (seq && activityItems[seq]) {
          var it = activityItems[seq];
          var elapsed = ((Date.now()-it.start)/1000).toFixed(1);
          var el = document.getElementById('activity-'+seq);
          if (el) {
            var dt = el.querySelector('.activity-detail'); if (dt) dt.textContent = elapsed+'s';
            var ic = el.querySelector('.activity-icon'); if (ic) ic.className = 'activity-icon done';
            var d = document.getElementById('activity-dur-'+seq); if (d) d.textContent = elapsed+'s';
          }
          if (q && !q.length) delete pendingTools[ak];
        }
      }
      if (data.event === 'Notification' && data.message) {
        activitySeq++;
        var el = document.createElement('div'); el.className = 'activity-item';
        el.innerHTML = '<div class="activity-icon" style="color:#ffd60a;">!</div>' +
          '<div class="activity-label"><span class="activity-detail">'+escapeHtml(data.message)+'</span></div>';
        list.appendChild(el); scrollEl.scrollTop = scrollEl.scrollHeight;
      }
    });

    function clearActivityFeed() {
      Object.keys(activityItems).forEach(function(k) { if (activityItems[k].timer) clearInterval(activityItems[k].timer); });
      activityItems = {}; pendingTools = {}; activitySeq = 0; hasActivityItems = false;
      document.getElementById('activityList').innerHTML = '<div class="panel-empty" id="activityEmpty">Waiting for activity...</div>';
      var strip = document.getElementById('runningAgents');
      Array.from(strip.children).forEach(function(c) { if (c._timer) clearInterval(c._timer); });
      strip.innerHTML = ''; strip.classList.remove('visible');
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       Helpers
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function escapeHtml(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    function isMcpTool(t) { return t && t.startsWith('mcp__') && t.indexOf('__',5) !== -1; }
    function mcpToolShortName(t) { var i = t.lastIndexOf('__'); return i > 4 ? t.substring(i+2) : t; }
    function prettifyToolName(t) {
      if (t === 'Search') return 'üîç Search';
      if (!isMcpTool(t)) return escapeHtml(t);
      var s = mcpToolShortName(t);
      return '<span class="activity-badge mcp">MCP</span>'+escapeHtml(s.replace(/_/g,' ').replace(/\b\w/g,function(c){return c.toUpperCase();}));
    }
    function summarizeMcpInput(n, i) {
      switch(n) {
        case 'get_context': return i.context_type||'';
        case 'show_overlay': return i.loading?'loading...':i.text?(i.text.length>50?i.text.substring(0,47)+'...':i.text):'';
        case 'search_rtstream': return i.query?'"'+(i.query.length>40?i.query.substring(0,37)+'...':i.query)+'"':'';
        case 'update_prompt': return i.stream_id?'stream: '+i.stream_id:'';
        default: return '';
      }
    }
    function summarizeInput(tn, raw) {
      try {
        var i = typeof raw === 'string' ? JSON.parse(raw) : raw; if (!i) return '';
        if (isMcpTool(tn)) return summarizeMcpInput(mcpToolShortName(tn), i);
        if (tn==='Read'&&i.file_path) return i.file_path;
        if (tn==='Write'&&i.file_path) return i.file_path;
        if (tn==='Edit'&&i.file_path) return i.file_path;
        if (tn==='Bash'&&i.command) { var c=i.command; return c.length>60?c.substring(0,57)+'...':c; }
        if (tn==='Search'&&i.query) return '"'+(i.query.length>50?i.query.substring(0,47)+'...':i.query)+'"';
        if (tn==='Grep'&&i.pattern) return i.pattern;
        if (tn==='Glob'&&i.pattern) return i.pattern;
        if (tn==='Task'&&i.description) return i.description;
        if (tn==='Task'&&i.agent_type) return i.agent_type;
        var k = Object.keys(i);
        if (k.length) { var v=String(i[k[0]]); return v.length>50?v.substring(0,47)+'...':v; }
      } catch(e) {} return '';
    }
    function formatTooltipInput(tn, raw) {
      try {
        var i = typeof raw === 'string' ? JSON.parse(raw) : raw;
        if (!i || typeof i !== 'object') return raw || '';
        var lines = [];
        Object.keys(i).forEach(function(k) {
          var v = i[k], s = typeof v === 'string' ? v : JSON.stringify(v);
          if (s && s.length > 200) s = s.substring(0, 197) + '‚Ä¶';
          lines.push(k + ': ' + s);
        });
        return lines.join('\n');
      } catch(e) { return String(raw || '').substring(0, 300); }
    }
    function showActivityTooltip(e) {
      var el = e.currentTarget, seq = el.dataset.seq;
      var it = activityItems[seq]; if (!it) return;
      var tt = document.getElementById('activityTooltip');
      var html = '';
      // Status
      var statusLabel = it.status === 'running' ? '‚óè Running' : it.status === 'done' ? '‚úì Completed' : '‚úó Failed';
      html += '<div class="tt-status ' + it.status + '">' + statusLabel;
      if (it.elapsed) html += ' (' + it.elapsed + 's)';
      html += '</div>';
      // Tool name
      html += '<div class="tt-label">Tool</div><div class="tt-value">' + escapeHtml(it.toolName) + '</div>';
      // Input
      var inp = formatTooltipInput(it.toolName, it.input);
      if (inp) html += '<div class="tt-label">Input</div><div class="tt-value">' + escapeHtml(inp) + '</div>';
      // Output / error (only for finished)
      if (it.output && it.status !== 'running') {
        var out = it.output;
        try { out = JSON.parse(out); } catch(_) {}
        if (typeof out === 'object') out = JSON.stringify(out, null, 2);
        out = String(out);
        if (out.length > 400) out = out.substring(0, 397) + '‚Ä¶';
        var lbl = it.status === 'fail' ? 'Error' : 'Output';
        var cls = it.status === 'fail' ? ' tt-error' : '';
        html += '<div class="tt-label">' + lbl + '</div><div class="tt-value' + cls + '">' + escapeHtml(out) + '</div>';
      }
      tt.innerHTML = html;
      // Position: above the item, aligned left
      var rect = el.getBoundingClientRect();
      var ttW = 360, ttH = tt.offsetHeight || 100;
      tt.classList.add('visible');
      var left = Math.max(4, Math.min(rect.left, window.innerWidth - ttW - 8));
      var top = rect.top - tt.offsetHeight - 6;
      if (top < 4) top = rect.bottom + 6;
      tt.style.left = left + 'px'; tt.style.top = top + 'px';
    }
    function hideActivityTooltip() {
      document.getElementById('activityTooltip').classList.remove('visible');
    }

    /* ‚îÄ‚îÄ‚îÄ Permission ‚îÄ‚îÄ‚îÄ */
    ipcRenderer.on('permission-prompt', (event, data) => {
      var p = document.getElementById('permissionPrompt');
      document.getElementById('permissionTool').textContent = data.toolName||'Unknown tool';
      var s = typeof data.toolInput==='string'?data.toolInput:JSON.stringify(data.toolInput,null,2);
      document.getElementById('permissionInput').textContent = s||'(no input)';
      p.classList.add('visible');
    });
    function respondPermission(d) {
      ipcRenderer.send('permission-response', d);
      document.getElementById('permissionPrompt').classList.remove('visible');
    }

    /* ‚îÄ‚îÄ‚îÄ Window Resize ‚îÄ‚îÄ‚îÄ */
    (function() {
      var h = document.getElementById('resizeHandle'), sx, sy, sw, sh;
      h.addEventListener('mousedown', function(e) {
        e.preventDefault(); sx=e.screenX; sy=e.screenY; sw=window.outerWidth; sh=window.outerHeight;
        document.addEventListener('mousemove', mv); document.addEventListener('mouseup', up);
      });
      function mv(e) { ipcRenderer.send('overlay-resize', {width:Math.max(250,sw+(e.screenX-sx)),height:Math.max(150,sh+(e.screenY-sy))}); }
      function up() { document.removeEventListener('mousemove',mv); document.removeEventListener('mouseup',up); }
    })();

    function openPlayerUrl() { if (currentPlayerUrl) shell.openExternal(currentPlayerUrl); }
    function closeOverlay() { ipcRenderer.send('overlay-close'); }
  </script>
</body>
</html>
